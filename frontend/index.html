<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViewXI - FPL Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #030118; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #0ea5e9; }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
                View<span style="color: #00ff87;">XI</span> Dashboard
            </h1>
            <p class="text-slate-400">Enter your FPL Team ID to get an instant overview.</p>
        </header>

        <footer class="text-center mt-8">
            <button id="feedback-link" class="text-cyan-400 hover:underline">Got Feedback or an Idea?</button>
        </footer>
        
        <div class="flex flex-col sm:flex-row justify-center items-center gap-2 mb-8">
            <input type="number" id="team-id-input" placeholder="e.g., 123456", min="1", class="bg-slate-800 border border-slate-600 rounded-md px-4 py-2 text-lg text-white w-full max-w-xs focus:ring-2 focus:ring-cyan-400 focus:outline-none transition">
            <input type="number" id="gameweek-input" placeholder="GW",min="1", class="bg-slate-800 border border-slate-600 rounded-md px-4 py-2 text-lg text-white w-24 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition">
            <button id="submit-button" class="bg-gradient-to-r from-[#37003c] to-[#6a00ff] text-white font-bold py-2 px-6 rounded-md text-lg hover:opacity-90 transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                Get Team
            </button>
        </div>

        
        <div id="loading-state" class="text-center text-cyan-400 text-xl hidden my-8">Loading...</div>
        <div id="error-container" class="text-center text-red-400 border border-red-400 bg-red-900/20 p-4 rounded-md hidden my-8"></div>

       
        <div id="results-container" class="bg-slate-800/50 rounded-lg shadow-lg overflow-hidden hidden">
            <div class="p-4 bg-slate-700/50">
                <h2 class="text-xl font-bold">Team Overview - Gameweek <span id="display-gameweek"></span></h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-700/50 text-slate-300 uppercase text-xs">
                        <tr>
                            <th class="p-4">Player</th>
                            <th class="p-4 hidden md:table-cell">Position</th>
                            <th class="p-4">Status</th>
                            <th class="p-4">Start Certainty</th>
                            <th class="p-4">Next Fixture</th> 
                        </tr>
                    </thead>
                    <tbody id="player-table-body" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Player Detail Modal -->
    <div id="player-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-slate-800 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-slate-600">
            <div class="sticky top-0 bg-slate-800 p-4 border-b border-slate-600 flex justify-between items-center z-10">
                <h2 id="modal-player-name" class="text-2xl font-bold text-white">Player Name</h2>
                <button id="modal-close-button" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="modal-details-grid" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>

    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-2xl w-full max-w-lg border border-slate-600">
            <div class="p-4 border-b border-slate-600 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white">Share Your Feedback</h2>
                <button id="feedback-modal-close-button" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
            <form id="feedback-form" action="https://formspree.io/f/mkgvbrqq" method="POST" class="p-6">
                <textarea name="feedback" required placeholder="What's on your mind? Did you find a bug? Have an idea for a new feature?" rows="5" class="bg-slate-900 border border-slate-600 rounded-md p-2 w-full text-white focus:ring-2 focus:ring-cyan-400 focus:outline-none"></textarea>
                <button type="submit" class="mt-4 w-full bg-gradient-to-r from-[#37003c] to-[#6a00ff] text-white font-bold py-2 px-6 rounded-md text-lg hover:opacity-90">Submit</button>
            </form>
        </div>
    </div>

    <script>
      
        const teamIdInput = document.getElementById('team-id-input');
        const gameweekInput = document.getElementById('gameweek-input');
        const playerTableBody = document.getElementById('player-table-body');
       
        let fullPlayerData = [];

        const preventNegativeInput = (event) => {
            
            if (parseInt(event.target.value, 10) < 1) {
                event.target.value = '';
            }
        };
        teamIdInput.addEventListener('input', preventNegativeInput);
        gameweekInput.addEventListener('input', preventNegativeInput);

       
        const renderTable = (players) => {
            playerTableBody.innerHTML = '';
            const positionOrder = { "GKP": 1, "DEF": 2, "MID": 3, "FWD": 4 };
            players.sort((a, b) => positionOrder[a.position] - positionOrder[b.position]);

            players.forEach(player => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700/50';

                // --- Player Cell  ---
                const nameCell = document.createElement('td');
                nameCell.className = 'p-4';

                const playerContainer = document.createElement('div');
                playerContainer.className = 'flex items-center gap-3';

                // 1. Create the image element
                const playerImage = document.createElement('img');
                
                // 2. Set the SRC to the direct photo_url from the API
                playerImage.src = player.photo_url;
                
                playerImage.alt = player.web_name;
                playerImage.className = 'w-10 h-10 rounded-full border-2 border-slate-600';

               
                playerImage.onerror = function() {
                    this.onerror = null; // Prevents infinite loops
                    this.src = 'https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_0-110.png';
                };

                const nameButton = document.createElement('button');
                nameButton.className = 'font-bold text-lg text-cyan-400 hover:underline';
                nameButton.textContent = player.web_name;
                nameButton.dataset.playerId = player.element;

                playerContainer.appendChild(playerImage);
                playerContainer.appendChild(nameButton);
                nameCell.appendChild(playerContainer);

               
                const posCell = document.createElement('td');
                posCell.className = 'p-4 text-slate-300 hidden md:table-cell';
                posCell.textContent = player.position;

                const statusCell = document.createElement('td');
                statusCell.className = 'p-4 font-semibold';
                statusCell.innerHTML = renderStatus(player.player_status);

                const certaintyCell = document.createElement('td');
                certaintyCell.className = 'p-4';
                certaintyCell.innerHTML = renderCertainty(player.start_certainty);

                const fixtureCell = document.createElement('td');
                const difficulty = player.next_opponent_difficulty;
                let colorClass = 'bg-slate-600';
                if (difficulty <= 2) colorClass = 'bg-green-500';
                else if (difficulty === 3) colorClass = 'bg-yellow-400';
                else if (difficulty >= 4) colorClass = 'bg-red-500';
                fixtureCell.innerHTML = `<div class="flex items-center gap-2">
                                           <span class="w-4 h-4 rounded-full ${colorClass}"></span>
                                           <span class="text-slate-300">${player.next_opponent_name}</span>
                                         </div>`;

                row.append(nameCell, posCell, statusCell, certaintyCell, fixtureCell);
                playerTableBody.appendChild(row);
            });
        };

       
        const displayGameweek = document.getElementById('display-gameweek');
        const submitButton = document.getElementById('submit-button');
        const loadingState = document.getElementById('loading-state');
        const errorContainer = document.getElementById('error-container');
        const resultsContainer = document.getElementById('results-container');
        const modal = document.getElementById('player-modal');
        const modalCloseButton = document.getElementById('modal-close-button');

        const renderStatus = (status) => {
            let icon = ''; let colorClass = '';
            switch (status) {
                case 'Available':   icon = '✅'; colorClass = 'text-green-400'; break;
                case 'Doubtful':    icon = '🟡'; colorClass = 'text-yellow-400'; break;
                case 'Injured':     icon = '❌'; colorClass = 'text-red-400'; break;
                case 'Suspended':   icon = '🟥'; colorClass = 'text-red-400'; break;
                default:            icon = '❓'; colorClass = 'text-slate-400';
            }
            return `<div class="flex items-center gap-2"><span class="text-xl">${icon}</span> <span class="${colorClass}">${status}</span></div>`;
        };
        const renderCertainty = (certainty) => {
            let icon = '';
            switch (certainty.split('(')[0].trim()) {
                case 'Nailed On': icon = '🔥'; break;
                case 'Likely Starter': icon = '✅'; break;
                case 'Doubtful': icon = '🟡'; break;
                case 'Rotation Risk': icon = '😐'; break;
                case 'Bench Player': icon = '❄️'; break;
                case 'Unavailable': icon = '❌'; break;
                default: icon = 'ℹ️';
            }
            return `<div class="flex items-center gap-2"><span class="text-xl">${icon}</span> <span>${certainty}</span></div>`;
        };
        const fetchTeamData = async () => {
            const teamId = teamIdInput.value; const gameWeek = gameweekInput.value;
            if (!teamId || !gameWeek) { showError("Please enter both a Team ID and a Gameweek."); return; }
            submitButton.disabled = true; loadingState.classList.remove('hidden'); errorContainer.classList.add('hidden'); resultsContainer.classList.add('hidden');
            displayGameweek.textContent = gameWeek;
            try {
                
                //const apiUrl = `http://127.0.0.1:8001/get_team_details?team_id=${teamId}&game_week=${gameWeek}`;
                const apiUrl = `https://view-ix-api.onrender.com/get_team_details?team_id=${teamId}&game_week=${gameWeek}`;
                const response = await fetch(apiUrl);
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || `An error occurred: ${response.statusText}`); }
                const data = await response.json(); fullPlayerData = data.players || [];
                if (fullPlayerData.length === 0) { showError(`No team data found for Gameweek ${gameWeek}. The gameweek may not be active yet.`); }
                else { renderTable(fullPlayerData); resultsContainer.classList.remove('hidden'); }
            } catch (error) { showError(error.message); }
            finally { submitButton.disabled = false; loadingState.classList.add('hidden'); }
        };
        const showError = (message) => { errorContainer.textContent = `Error: ${message}`; errorContainer.classList.remove('hidden'); };
        const showModal = (player) => {
            document.getElementById('modal-player-name').textContent = player.web_name;
            const modalGrid = document.getElementById('modal-details-grid');
            const details = {
                'Fitness': renderStatus(player.player_status),
                'Start Certainty': renderCertainty(player.start_certainty),
                'Injury News': `<span class="text-lg">${player.player_news}</span>`,
                'Next Opponent': `<div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full ${player.next_opponent_difficulty <= 2 ? 'bg-green-500' : player.next_opponent_difficulty === 3 ? 'bg-yellow-400' : 'bg-red-500'}"></span><span class="text-lg">${player.next_opponent_name}</span></div>`,
                'Position': `<span class="text-lg">${player.position}</span>`,
                'Cost': `<span class="text-lg">£${(player.now_cost / 10).toFixed(1)}m</span>`,
                'Goals Scored': `<span class="text-lg">${player.goals_scored}</span>`,
                'Assists': `<span class="text-lg">${player.assists}</span>`,
            };
            modalGrid.innerHTML = Object.entries(details).map(([key, value]) => `<div class="bg-slate-700/50 p-4 rounded-md"><h3 class="text-slate-400 text-sm font-bold mb-1">${key}</h3>${value}</div>`).join('');
            modal.classList.remove('hidden');
        };
        const hideModal = () => modal.classList.add('hidden');
        submitButton.addEventListener('click', fetchTeamData);
        teamIdInput.addEventListener('keydown', (e) => e.key === 'Enter' && fetchTeamData());
        gameweekInput.addEventListener('keydown', (e) => e.key === 'Enter' && fetchTeamData());
        playerTableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-player-id]');
            if (button) {
                const player = fullPlayerData.find(p => p.element === parseInt(button.dataset.playerId, 10));
                if (player) showModal(player);
            }
        });
        modalCloseButton.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => e.target === modal && hideModal());
    </script>
</body>
</html>