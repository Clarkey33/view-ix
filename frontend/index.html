<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViewXI - FPL Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #030118; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #0ea5e9; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
                View<span style="color: #00ff87;">XI</span> Dashboard
            </h1>
            <p class="text-slate-400">Enter your FPL Team ID to get an instant overview.</p>
        </header>

        <div class="flex flex-col sm:flex-row justify-center items-center gap-2 mb-8">
            <input type="number" id="team-id-input" placeholder="e.g., 123456" min="1" class="bg-slate-800 border border-slate-600 rounded-md px-4 py-2 text-lg text-white w-full max-w-xs focus:ring-2 focus:ring-cyan-400 focus:outline-none transition">
            <input type="number" id="gameweek-input" placeholder="GW" min="1" class="bg-slate-800 border border-slate-600 rounded-md px-4 py-2 text-lg text-white w-24 focus:ring-2 focus:ring-cyan-400 focus:outline-none transition">
            <button id="submit-button" class="bg-gradient-to-r from-[#37003c] to-[#6a00ff] text-white font-bold py-2 px-6 rounded-md text-lg hover:opacity-90 transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                Get Team
            </button>
        </div>

        <div class="text-center mb-8">
            <button id="how-to-link" class="text-sm text-cyan-400 hover:underline">How do I find my Team ID?</button>
        </div>
        
        <div id="loading-state" class="text-center text-cyan-400 text-xl hidden my-8">Loading...</div>
        <div id="error-container" class="text-center text-red-400 border border-red-400 bg-red-900/20 p-4 rounded-md hidden my-8"></div>

        <div id="results-container" class="bg-slate-800/50 rounded-lg shadow-lg overflow-hidden hidden">
            <div class="p-4 bg-slate-700/50">
                <h2 class="text-xl font-bold">Team Overview - Gameweek <span id="display-gameweek"></span></h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-700/50 text-slate-300 uppercase text-xs">
                        <tr id="standard-table-header-row">
                            <th class="p-4">Player</th>
                            <th class="p-4 hidden md:table-cell">Position</th>
                            <th class="p-4">Status</th>
                            <th class="p-4">Start Certainty</th>
                            <th class="p-4">Next Fixture</th> 
                        </tr>
                    </thead>
                    <tbody id="player-table-body" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>
        </div>



        <div id="planning-view-container" class="bg-slate-800/50 rounded-lg shadow-lg overflow-hidden hidden mt-8">
            <div class="p-4 bg-slate-700/50 border-b border-slate-600">
                <h2 class="text-xl font-bold">Planning for Gameweek <span id="planning-display-gameweek"></span></h2>
                <p class="text-sm text-slate-400 mt-1">
                    <span class="font-bold">NOTE:</span> Showing your final roster from GW<span id="planning-roster-gameweek"></span>. Transfers made for the upcoming gameweek are not yet visible.
                </p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-700/50 text-slate-300 uppercase text-xs">
                        <tr>
                            <th class="p-4">Player</th>
                            <th class="p-4">Status</th>
                            <th class="p-4">Next 3 Fixtures</th> 
                        </tr>
                    </thead>
                    <tbody id="planning-table-body" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-600 bg-slate-700/50">
                <h3 class="font-bold text-lg text-white mb-3">Decision Support</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    
                    <!-- Transfer Analysis Button -->
                    <a href="https://www.allaboutfpl.com/" target="_blank" rel="noopener noreferrer" 
                    class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-4 rounded-lg text-center no-underline transition-colors">
                        üöÄ Get Transfer Analysis
                    </a>
                    
                    <!-- Captaincy Analysis Button -->
                    <a href="https://allaboutfpl.com/category/captaincy-metrics/" target="_blank" rel="noopener noreferrer"
                    class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-4 rounded-lg text-center no-underline transition-colors">
                        ¬©Ô∏è Get Captaincy Advice
                    </a>

                </div>
            </div>
        </div>

        <!--footer -->
        <footer class="text-center mt-12 py-4">
            <button id="feedback-link" class="text-cyan-400 hover:underline text-sm">Got Feedback or an Idea?</button>
        </footer>

    </div>

    <!-- Player Detail Modal -->
    <div id="player-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-slate-800 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-slate-600">
            <div class="sticky top-0 bg-slate-800 p-4 border-b border-slate-600 flex justify-between items-center z-10">
                <h2 id="modal-player-name" class="text-2xl font-bold text-white">Player Name</h2>
                <button id="modal-close-button" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="modal-details-grid" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-2xl w-full max-w-lg border border-slate-600">
            <div class="p-4 border-b border-slate-600 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white">Share Your Feedback</h2>
                <button id="feedback-modal-close-button" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
        
            <form id="feedback-form" action="https://formspree.io/f/mkgvbrqq" method="POST" class="p-6">
                <textarea name="feedback" required placeholder="What's on your mind? Did you find a bug? Have an idea for a new feature?" rows="5" class="bg-slate-900 border border-slate-600 rounded-md p-2 w-full text-white focus:ring-2 focus:ring-cyan-400 focus:outline-none"></textarea>
                <button type="submit" class="mt-4 w-full bg-gradient-to-r from-[#37003c] to-[#6a00ff] text-white font-bold py-2 px-6 rounded-md text-lg hover:opacity-90">Submit</button>
            </form>
        </div>
    </div>

    <div id="how-to-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-2xl w-full max-w-lg border border-slate-600 text-slate-300">
            <!-- Header -->
            <div class="p-4 border-b border-slate-600 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white">How to Find Your FPL ID</h2>
                <button id="how-to-modal-close-button" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
            <!-- Body -->
            <div class="p-6 space-y-6">
                <p>Your Team ID is on the official FPL website (this is not available in the mobile app).</p>

                <div>
                    <p class="font-semibold text-white">Step 1: Go to the FPL Website</p>
                    <p class="text-slate-400 mb-3">Click the button below to open the FPL site and log in.</p>
                    <a href="https://fantasy.premierleague.com" target="_blank" rel="noopener noreferrer" 
                    class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-5 rounded-lg inline-block w-full text-center no-underline">
                        Log in to FPL Website
                    </a>
                </div>

                <div>
                    <p class="font-semibold text-white">Step 2: Find Your ID & Copy</p>
                    <p class="text-slate-400 mb-3">After you log in, click the <strong class="text-cyan-400">"Points"</strong> tab. Your Team ID is the number in the URL.</p>
                    <div class="bg-slate-900 p-3 rounded-lg break-all">
                        <code class="text-sm">https://fantasy.premierleague.com/entry/<strong class="bg-cyan-500 text-white px-1 rounded-md">123456</strong>/event/3</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const teamIdInput = document.getElementById('team-id-input');
        const gameweekInput = document.getElementById('gameweek-input');
        const submitButton = document.getElementById('submit-button');
        const loadingState = document.getElementById('loading-state');
        const errorContainer = document.getElementById('error-container');

        // Standard + Historical View Elements
        const resultsContainer = document.getElementById('results-container');
        const displayGameweek = document.getElementById('display-gameweek');
        const standardTableHeaderRow = document.getElementById('standard-table-header-row');
        const playerTableBody = document.getElementById('player-table-body');

        // Planning View Elements
        const planningViewContainer = document.getElementById('planning-view-container');
        const planningDisplayGameweek = document.getElementById('planning-display-gameweek');
        const planningRosterGameweek = document.getElementById('planning-roster-gameweek');
        const planningTableBody = document.getElementById('planning-table-body');

        // Modal & Other Elements
        const modal = document.getElementById('player-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const feedbackLink = document.getElementById('feedback-link');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackModalCloseButton = document.getElementById('feedback-modal-close-button');
        const feedbackForm = document.getElementById('feedback-form');
        const howToLink = document.getElementById('how-to-link');
        const howToModal = document.getElementById('how-to-modal');
        const howToModalCloseButton = document.getElementById('how-to-modal-close-button');

        let fullPlayerData = [];

        // --- Auto-fetch current gameweek on page load ---
        const initializeView = async () => {
            try {
                const response = await fetch('http://localhost:8001/gameweek_status'); // Use your local backend port
                if (!response.ok) return;
                const data = await response.json();
                if (data.next_gameweek) {
                    gameweekInput.value = data.next_gameweek;
                }
            } catch (error) {
                console.error("Could not fetch gameweek status:", error);
            }
        };
        document.addEventListener('DOMContentLoaded', initializeView);

        // --- Input Validation ---
        const preventNegativeInput = (event) => {
            if (parseInt(event.target.value, 10) < 1) event.target.value = '';
        };
        teamIdInput.addEventListener('input', preventNegativeInput);
        gameweekInput.addEventListener('input', preventNegativeInput);

        // --- Main API Call Function ---
        const fetchTeamData = async () => {
            const teamId = teamIdInput.value;
            const gameWeek = gameweekInput.value;
            if (!teamId || !gameWeek) {
                showError("Please enter both a Team ID and a Gameweek.");
                return;
            }
            submitButton.disabled = true;
            loadingState.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            planningViewContainer.classList.add('hidden');

            try {
                const apiUrl = `http://localhost:8001/get_team_details?team_id=${teamId}&game_week=${gameWeek}`; // Use your local backend port
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `An error occurred: ${response.statusText}`);
                }
                const data = await response.json();
                fullPlayerData = data.players || [];

                if (data.view_mode === "planning") {
                    renderPlanningView(data);
                } else {
                    renderStandardView(data);
                }
            } catch (error) {
                showError(error.message);
            } finally {
                submitButton.disabled = false;
                loadingState.classList.add('hidden');
            }
        };

        // --- UI Rendering Functions ---
        function renderStandardView(data) {
            if (!data.players || data.players.length === 0) {
                showError(`No team data found for Gameweek ${gameweekInput.value}.`);
                return;
            }
            const isLiveView = data.players[0].start_certainty !== null;
            displayGameweek.textContent = gameweekInput.value;
            renderTableHeaders(isLiveView);
            playerTableBody.innerHTML = '';
            const positionOrder = { "GKP": 1, "DEF": 2, "MID": 3, "FWD": 4 };
            data.players.sort((a, b) => positionOrder[a.position] - positionOrder[b.position]);
            data.players.forEach(player => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700/50';
                let cells = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${player.photo_url}" alt="${player.web_name}" class="w-10 h-10 rounded-full border-2 border-slate-600" onerror="this.onerror=null;this.src='https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_0-110.png';">
                            <button class="font-bold text-lg text-cyan-400 hover:underline" data-player-id="${player.element}">${player.web_name}</button>
                        </div>
                    </td>
                    <td class="p-4 text-slate-300 hidden md:table-cell">${player.position}</td>
                `;

                if (isLiveView) {
                    cells += `
                        <td class="p-4 font-semibold">${renderStatus(player.player_status)}</td>
                        <td class="p-4">${renderCertainty(player.start_certainty)}</td>
                        <td class="p-4">${renderFixture(player.next_opponent_name, player.next_opponent_difficulty)}</td>
                    `;
                } else { // Historical View
                    cells += `
                        <td class="p-4">${renderResult(player)}</td>
                    `;
                }
                row.innerHTML = cells;
                playerTableBody.appendChild(row);
            });
            resultsContainer.classList.remove('hidden');
        }

        function renderPlanningView(data) {
            planningDisplayGameweek.textContent = data.requested_gameweek;
            planningRosterGameweek.textContent = data.roster_gameweek;
            planningTableBody.innerHTML = '';
            const positionOrder = { "GKP": 1, "DEF": 2, "MID": 3, "FWD": 4 };
            data.players.sort((a, b) => positionOrder[a.position] - positionOrder[b.position]);
            data.players.forEach(player => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700/50';
                row.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${player.photo_url}" alt="${player.web_name}" class="w-10 h-10 rounded-full border-2 border-slate-600" onerror="this.onerror=null;this.src='https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_0-110.png';">
                            <button class="font-bold text-lg text-cyan-400 hover:underline" data-player-id="${player.element}">${player.web_name}</button>
                        </div>
                    </td>
                    <td class="p-4 font-semibold">${renderStatus(player.player_status)}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-2 flex-wrap">
                            ${player.upcoming_fixtures.map(fixture => renderFixture(fixture.opponent_name, fixture.difficulty)).join('')}
                        </div>
                    </td>
                `;
                planningTableBody.appendChild(row);
            });
            planningViewContainer.classList.remove('hidden');
        }

        function renderTableHeaders(isLive) {
            if (isLive) {
                standardTableHeaderRow.innerHTML = `
                    <th class="p-4">Player</th>
                    <th class="p-4 hidden md:table-cell">Position</th>
                    <th class="p-4">Status</th>
                    <th class="p-4">Start Certainty</th>
                    <th class="p-4">Opponent</th> 
                `;
            } else {
                standardTableHeaderRow.innerHTML = `
                    <th class="p-4">Player</th>
                    <th class="p-4 hidden md:table-cell">Position</th>
                    <th class="p-4">Result</th>
                `;
            }
        }
        
        // --- Visual Helper Functions ---
        const renderStatus = (status) => {
            let icon = '', colorClass = '';
            switch (status) {
                case 'Available':   icon = '‚úÖ'; colorClass = 'text-green-400'; break;
                case 'Doubtful':    icon = 'üü°'; colorClass = 'text-yellow-400'; break;
                case 'Injured':     icon = '‚ùå'; colorClass = 'text-red-400'; break;
                case 'Suspended':   icon = 'üü•'; colorClass = 'text-red-400'; break;
                default:            icon = '‚ùì'; colorClass = 'text-slate-400';
            }
            return `<div class="flex items-center gap-2"><span class="text-xl">${icon}</span> <span class="${colorClass}">${status}</span></div>`;
        };

        const renderCertainty = (certainty) => {
            if (!certainty) return 'N/A';
            let icon = '';
            switch (certainty.split('(')[0].trim()) {
                case 'High': icon = 'üî•'; break;
                case 'Likely Starter': icon = '‚úÖ'; break;
                case 'Doubtful': icon = 'üü°'; break;
                case 'Rotation Risk': icon = 'üòê'; break;
                case 'Bench Player': icon = '‚ùÑÔ∏è'; break;
                default: icon = '‚ÑπÔ∏è';
            }
            return `<div class="flex items-center gap-2"><span class="text-xl">${icon}</span> <span>${certainty}</span></div>`;
        };

        const renderFixture = (opponentName, difficulty) => {
            let colorClass = 'bg-slate-600';
            if (difficulty <= 2) colorClass = 'bg-green-500';
            else if (difficulty === 3) colorClass = 'bg-yellow-400';
            else if (difficulty >= 4) colorClass = 'bg-red-500';
            return `<div class="flex items-center gap-2 p-1 rounded-md"><span class="w-4 h-4 rounded-full ${colorClass}"></span><span class="text-slate-300">${opponentName}</span></div>`;
        };

        const renderResult = (player) => {
            if (player.opponent === null) return 'N/A';
            return `
                <div class="font-semibold">${player.opponent}</div>
                <div class="text-sm text-slate-400">${player.player_team_score} - ${player.opponent_team_score}</div>
            `;
        };

        const showError = (message) => {
            errorContainer.textContent = `Error: ${message}`;
            errorContainer.classList.remove('hidden');
        };

        // --- Modal Functions ---



        const showModal = (player) => {
            document.getElementById('modal-player-name').textContent = player.web_name;
            const modalGrid = document.getElementById('modal-details-grid');
            
            // --- The Dynamic Details Object ---
            let details = {}; // Start with an empty object

            // --- Determine the View Mode ---
            const isPlanningView = player.upcoming_fixtures !== undefined;
            const isLiveView = player.start_certainty !== undefined; // <-- Our new, reliable fingerprint

            if (isPlanningView) {
                // --- PLANNING VIEW MODAL ---
                details = {
                    'Fitness': renderStatus(player.player_status),
                    'Injury News': `<span class="text-lg">${player.player_news || "No news"}</span>`,
                    'Start Certainty': renderCertainty(player.start_certainty),
                    'Cost': `<span class="text-lg">¬£${(player.now_cost / 10).toFixed(1)}m</span>`,
                    'Position': `<span class="text-lg">${player.position}</span>`,
                    'Total Goals (Season)': `<span class="text-lg">${player.goals_scored ?? 'N/A'}</span>`,
                    'Total Assists (Season)': `<span class="text-lg">${player.assists ?? 'N/A'}</span>`,
                };
            } else if (isLiveView) {
                // --- LIVE VIEW MODAL ---
                details = {
                    //'Opponent': renderFixture(player.next_opponent_name, player.next_opponent_difficulty),
                    'Result': renderResult(player),
                    'Fitness': renderStatus(player.player_status),
                    'Injury News': `<span class="text-lg">${player.player_news || "No news"}</span>`,
                    'Start Certainty': renderCertainty(player.start_certainty),
                    'Cost': `<span class="text-lg">¬£${(player.now_cost / 10).toFixed(1)}m</span>`,
                    'Gameweek Points': `<span class="text-lg">${player.event_points ?? 'N/A'}</span>`,
                    'Bonus Points (BPS)': `<span class="text-lg">${player.bps ?? 'N/A'}</span>`,
                    'Position': `<span class="text-lg">${player.position}</span>`,
                };
            } else {
                // --- HISTORICAL VIEW MODAL (Default) ---
                details = {
                    'Result': renderResult(player),
                    'Cost': `<span class="text-lg">¬£${(player.now_cost / 10).toFixed(1)}m</span>`,
                    'Position': `<span class="text-lg">${player.position}</span>`,
                    'Total Goals (Season)': `<span class="text-lg">${player.goals_scored ?? 'N/A'}</span>`,
                    'Total Assists (Season)': `<span class="text-lg">${player.assists ?? 'N/A'}</span>`,
                };
            }
            
            // --- Render the final object ---
            modalGrid.innerHTML = Object.entries(details)
                .map(([key, value]) => `<div class="bg-slate-700/50 p-4 rounded-md"><h3 class="text-slate-400 text-sm font-bold mb-1">${key}</h3>${value}</div>`)
                .join('');
                
            modal.classList.remove('hidden');
        };

        const hideModal = () => modal.classList.add('hidden');
        const showFeedbackModal = () => feedbackModal.classList.remove('hidden');
        const hideFeedbackModal = () => feedbackModal.classList.add('hidden');
        const showHowToModal = () => howToModal.classList.remove('hidden');
        const hideHowToModal = () => howToModal.classList.add('hidden');

        // --- Event Listeners ---
        howToLink.addEventListener('click', showHowToModal);
        howToModalCloseButton.addEventListener('click', hideHowToModal);
        howToModal.addEventListener('click', (e) => e.target === howToModal && hideHowToModal());
        submitButton.addEventListener('click', fetchTeamData);
        teamIdInput.addEventListener('keydown', (e) => e.key === 'Enter' && fetchTeamData());
        gameweekInput.addEventListener('keydown', (e) => e.key === 'Enter' && fetchTeamData());
        document.querySelector('.container').addEventListener('click', (e) => {
            const button = e.target.closest('button[data-player-id]');
            if (button) {
                const player = fullPlayerData.find(p => p.element === parseInt(button.dataset.playerId, 10));
                if (player) showModal(player);
            }
        });
        modalCloseButton.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => e.target === modal && hideModal());
        feedbackLink.addEventListener('click', showFeedbackModal);
        feedbackModalCloseButton.addEventListener('click', hideFeedbackModal);
        feedbackModal.addEventListener('click', (e) => e.target === feedbackModal && hideFeedbackModal());
        feedbackForm.addEventListener('submit', function(e) {
            e.preventDefault(); const form = e.target; const data = new FormData(form);
            fetch(form.action, { method: 'POST', body: data, headers: { 'Accept': 'application/json' } })
            .then(response => {
                if (response.ok) {
                    alert('Thanks for your feedback!');
                    form.reset(); hideFeedbackModal();
                } else { alert('Oops! There was a problem submitting your form.'); }
            }).catch(() => alert('Oops! There was a problem submitting your form.'));
        });


    </script>
</body>